{% extends 'base.html' %}

{% block title %}Search Results{% endblock title %}

{% block body %}

<div class="container my-5">
    {% for products, range, nSlides in all_products %}
    <h5>Recommended Items in {{products.0.category}}</h5>
    <div id="carouselControls{{forloop.counter}}" class="carousel slide my-3" data-bs-ride="carousel">
        <div class="carousel-inner">
            <!-- First slide of the carousel -->
            <div class="carousel-item active">
                <div class="row">
                    <!-- start a row of items-->
                    {% for i in products|slice:"0:" %}

                    <div class="col-xs-3 col-sm-3 col-md-3">
                        <!-- This is second coloumn of that row-->
                        <div class="card align-items-center" style="width: 18rem;">
                            <!-- And that is a card-->
                            <img src='/media/{{i.image}}' class="card-img-top" id="imgpr{{i.id}}" height="320"
                                width="240">
                            <!--Maintain 4:3-->
                            <div class="card-body">
                                <h5 class="card-title" id="namepr{{i.id}}">{{i.product_name}}</h5>
                                <p class="card-text" id="descpr{{i.id}}">{{i.desc|slice:"0:25"}}..</p>
                                <p class="card-text" id="pricepr{{i.id}}">â‚¹{{i.price}}</p>
                                <span id="divpr{{i.id}}" class="divpr">
                                    <button tabindex="0" data-bs-toggle="popover" data-bs-trigger="focus"
                                        data-bs-content="Item added successfully!" id="pr{{i.id}}"
                                        class="btn btn-primary cart"><i class="fa fa-cart-plus"></i>
                                        Add To Cart</button></span>
                                <a href="productview/{{i.id}}"><button id="qv{{i.id}}"
                                        class="btn btn-primary quickview"><i class="fa fa-eye"></i> View</button></a>
                            </div>
                        </div>
                    </div>
                    {% if forloop.counter|divisibleby:4 and forloop.counter > 0 and not forloop.last %}
                </div>
            </div>

            <div class="carousel-item">
                <div class="row">
                    {%endif%}
                    {%endfor%}
                </div>
            </div>


        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselControls{{forloop.counter}}"
            data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="false"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselControls{{forloop.counter}}"
            data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="false"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
    {% endfor %}
</div>

{% block js %}
<script>
    {% if msg|length != 0 %}
    alert('{{msg}}');
    window.location.href = "/"
    {% endif %}

    function updateCart(cart) {
        var num = 0;
        for (var i in cart)
            num += (cart[i][0]);

        localStorage.setItem('cart', JSON.stringify(cart)); //Failing to do this will lead to loss of data of cart when page is reloaded
        document.getElementById('cart').innerHTML = num;
        console.log(cart);
    }
    //Find out the cart from the local storage
    if (localStorage.getItem('cart') == null) {
        var cart = {}; //Make a new cart
    }
    else {
        cart = JSON.parse(localStorage.getItem('cart'));
        updateCart(cart);  //Update existing cart
    }

    // using some jQuery
    $('.divpr').on('click', 'button.cart', function () {

        var idStr = this.id.toString(); //divpr's button's id like pr1, etc ; toString bcz only strings are accepted
        if (cart[idStr] != undefined) {
            var qty = cart[idStr][0] + 1;
            cart[idStr] = [qty, name, price, img];
            // name = "My item"; //No need to change the name if that item is already present
        }
        else {
            qty = 1;
            name = document.getElementById('name' + idStr).innerHTML; //idStr is like pr1, pr2. Thus, target by name etc (id of card title)
            price = document.getElementById('price' + idStr).innerHTML;
            img = document.getElementById('img' + idStr).src;
            cart[idStr] = [qty, name, price, img];
        }
        updateCart(cart);
    });

    //Bootstrap Code for enabling popover
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl)
    })
    var popover = new bootstrap.Popover(document.querySelector('.popover-dismiss'), {
        trigger: 'focus'
    })

</script>
{% endblock %}

{% endblock body %}