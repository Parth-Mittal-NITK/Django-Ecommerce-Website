{% extends 'base.html' %}

{% block title %}Checkout{% endblock title %}

{% block body %}
<div class="container my-3">
    <h3>Review Your Cart Items</h3>
    <div class="container my-4 col-12">
        <ul class="list-group" id="items">
        </ul>
        <br>
        <h5 style="text-align:end"> Total = ₹<span id="totalPrice"></span> </h5>
        <div class="container">
            <h3>Delivery Details</h3>
            <p> <b>{{user.first_name}} {{user.last_name}}</b> <br>
                {{user.address.addressline}} <br>
                {{user.address.city}}, {{user.address.state}} -{{user.address.zip_code}} <br>
                {{user.address.phone}}</p>
        </div>

        <form method="POST" action="checkout">
            {% csrf_token %}
            <input type="hidden" name="items_json" id="items_json">

            <div class="col-12">
                <a href="/checkout/"><button class="btn btn-danger float-end" type="submit">Place Order</button></a>
            </div>
        </form>
    </div>

</div>


{%block js%}
<script>

    if (localStorage.getItem('cart') == null) {
        var cart = {}; //Make a new cart
    }
    else {
        cart = JSON.parse(localStorage.getItem('cart'));
        updateCart(cart);
    }

    function updateCart(cart) {
        var num = 0;
        for (var i in cart)
            num += (cart[i][0]);

        localStorage.setItem('cart', JSON.stringify(cart)); //Failing to do this will lead to loss of data of cart when page is reloaded
        document.getElementById('cart').innerHTML = num;
        //console.log(cart);
    }

    if ($.isEmptyObject(cart)) {
        mystr = `<p>Your cart is empty. Please add some more items before proceeding!</p>`
        $('#items').append(mystr);
    }
    else {
        //js to display the cart items on checkout page
        var totalPrice = 0;
        var itemPrice = 0;

        for (i in cart) {
            let qty = cart[i][0];
            let name = cart[i][1];
            let price = cart[i][2];
            let img = cart[i][3];

            itemPrice = parseInt(qty) * parseInt(price.slice(1,));
            totalPrice += itemPrice;

            mystr = `<li class="list-group-item d-flex justify-content-between align-items-start">
                
                <div class="ms-2 me-auto">
                    <img src="${img}" height="200" width="160">
                    <div class="fw-bold">${name}</div>
                    <p>${price}*${qty} = ₹${itemPrice}<p>
                </div>
                
                <span class="badge bg-danger rounded-pill">${qty}</span>
            </li>`
            $('#items').append(mystr); //jQuery, Here even though items is an id, # is used for appending
        }
        document.getElementById('totalPrice').innerHTML = totalPrice;
        //console.log(totalPrice);
    }

    $('#items_json').val(JSON.stringify(cart));
    {% if ordered == True %}
    alert('Thanks for shopping with us!');
    localStorage.clear();
    document.location = "/";
    {% endif %}
</script>

{%endblock%}
{% endblock body %}